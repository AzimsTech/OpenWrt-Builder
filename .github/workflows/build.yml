name: Build and Publish OpenWrt Image

on:
  workflow_dispatch:
    inputs:
      model:
        description: 'Device Model:'
        required: true
      target:
        description: 'Target Architecture:'
        required: false
      version:
        description: 'OpenWrt Version:'
        required: true
      packages:
        description: 'Extra Packages:'
        required: false
      disabled_services:
        description: 'Disabled Services:'
        required: false
      scripts:
        description: 'UCI Defaults Scripts:'
        required: false
      customScripts:
        description: 'Custom Scripts:'
        required: false
      share_url:
        description: 'Shareable Configuration URL:'
        required: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache build dependencies
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: build-essential libncurses-dev zlib1g-dev gawk wget git gettext libssl-dev xsltproc rsync unzip python3 python3-setuptools zstd aria2
          version: 1.0

      - name: Create custom scripts
        if: ${{ github.event.inputs.scripts == '99-custom' }}
        run: |
          cat <<'CUSTOM_SCRIPT_EOF' > files/etc/uci-defaults/99-custom
          ${{ github.event.inputs.customScripts }}
          CUSTOM_SCRIPT_EOF
          cat files/etc/uci-defaults/99-custom

      - name: Process UCI defaults script
        run: |
          UCI_DIR="files/etc/uci-defaults"

          if [ -n "${{ github.event.inputs.scripts }}" ]; then
            # Keep only the specified script
            SCRIPT="${{ github.event.inputs.scripts }}"
            echo "SCRIPT=$SCRIPT" >> $GITHUB_ENV
            
            if [ ! -f "$UCI_DIR/$SCRIPT" ]; then
              echo "Error: Script '$SCRIPT' not found"
              exit 1
            fi
            
            # Remove all other files
            find "$UCI_DIR" -type f ! -name "$SCRIPT" -delete 2>/dev/null || true
            echo "Kept only: $SCRIPT"
            
          else
            # Remove all files
            rm -f "$UCI_DIR"/* 2>/dev/null || true
            echo "Removed all UCI scripts"
          fi

      - name: Create build configuration
        run: |
          # Create input configuration file
          cat <<EOF > input_config
          openwrt_version=${{ github.event.inputs.version }}
          packages=${{ github.event.inputs.packages }}
          files=files
          profile=${{ github.event.inputs.model }}
          target=${{ github.event.inputs.target }}
          EOF

          # Add disabled services if specified
          if [ -n "${{ github.event.inputs.disabled_services }}" ]; then
            echo "disabled_services=${{ github.event.inputs.disabled_services }}" >> input_config
          fi

          # Export configuration to environment
          cat input_config >> $GITHUB_ENV

      - name: Inject secrets into scripts
        if: ${{ github.event.inputs.scripts }}
        run: |
          sed -i \
            -e 's/^# ssid=".*"/ssid="${{ secrets.WLAN_NAME }}"/' \
            -e 's/^# ssid_key=".*"/ssid_key="${{ secrets.WLAN_PASS }}"/' \
            -e 's/^# root_password=".*"/root_password="${{ secrets.ROOT_PASS }}"/' \
            -e 's/^# pppoe_name=".*"/pppoe_name="${{ secrets.PPPOE_NAME }}"/' \
            -e 's/^# pppoe_key=".*"/pppoe_key="${{ secrets.PPPOE_PASS }}"/' \
            files/etc/uci-defaults/${{ env.SCRIPT }}

      - name: Fetch version buildinfo
        id: fetch_version_buildinfo
        run: |
          version="${{ env.openwrt_version }}"
          target="${{ env.target }}"

          # Construct URL based on version
          if [[ $version == "SNAPSHOT" ]]; then
            url="https://downloads.openwrt.org/${version,,}s/targets/${target}/version.buildinfo"
          else
            url="https://downloads.openwrt.org/releases/${version}/targets/${target}/version.buildinfo"
          fi

          wget $url
          echo "version_buildinfo=$(cat version.buildinfo)" >> $GITHUB_ENV

          # Extract 7-character commit hash directly from file
          # Format: r28784-155eea44e7 -> 155eea4
          commit_hash=$(cat version.buildinfo | sed 's/.*-//' | cut -c1-7)
          echo "commit_hash=$commit_hash" >> $GITHUB_ENV

          # Extract revision number
          # Format: r28784-155eea44e7 -> r28784
          revision_number=$(cat version.buildinfo | sed 's/-.*//')
          echo "revision_number=$revision_number" >> $GITHUB_ENV

      - name: Cache OpenWrt Image Builder
        id: cache-openwrt
        if: always()
        uses: actions/cache@v4
        with:
          path: openwrt-imagebuilder-*.tar.*
          key: openwrt-imagebuilder-${{ env.openwrt_version }}-${{ env.target }}-${{ env.commit_hash }}

      - name: Download OpenWrt Image Builder
        if: steps.cache-openwrt.outputs.cache-hit != 'true'
        run: |
          version_path=$([ "${{ github.event.inputs.version }}" = "SNAPSHOT" ] && echo snapshots || echo "releases/${{ github.event.inputs.version }}")
          chmod +x ./setup.sh
          TARGET=${{ env.target }} \
          VERSION_PATH=${version_path} ./setup.sh

      - name: Build OpenWrt image
        continue-on-error: true
        run: |
          tar xf openwrt-imagebuilder-*.tar.* --strip=1 --no-same-owner -C .
          make -j $(nproc) image \
            PROFILE="${{ env.profile }}" \
            PACKAGES="${{ env.packages }}" \
            FILES="${{ env.files }}" \
            DISABLED_SERVICES="${{ env.disabled_services }}"

      - name: Generate build information
        run: |
          # Format variables for display
          scripts="${{ env.SCRIPT != '' && env.SCRIPT || 'false' }}"
          disabled_services="${{ env.disabled_services != '' && env.disabled_services || 'false' }}"
          packages="${{ env.packages != '' && env.packages || 'default' }}"

          # Find target directory
          target_dir=$(find bin/targets/*/*/ -type d -print -quit)
          echo "image_path=$target_dir" >> $GITHUB_ENV

          # Extract version code from profiles.json 
          version_code=$(grep -o '"version_code":"[^"]*"' $target_dir/profiles.json | awk -F: '{print $2}' | tr -d '"')

          # Use GitHub Actions environment variables
          GITHUB_REPO="${GITHUB_REPOSITORY}"
          RELEASE_TAG="${{ env.revision_number }}-${{ github.event.inputs.model }}"
          SHARE_URL="${{ github.event.inputs.share_url }}"


          # Format display variables
          packages_display=$(printf "\`%s\` " $packages)
          disabled_services_display=$(printf "\`%s\` " $disabled_services)
          
          # Generate checksums table first
          checksums_table=$(awk -v repo="$GITHUB_REPO" -v tag="$RELEASE_TAG" '$2 ~ /(sysupgrade|factory|recovery)\.bin$/ {
            gsub(/\*/, "", $2); 
            printf "| `%s`<br>[%s](https://github.com/%s/releases/download/%s/%s) |\n", $1, $2, repo, tag, $2
          }' "$target_dir/sha256sums")

          # Create build info markdown file with direct variable expansion
          cat > build_info.md <<EOF
          ## ðŸ’¡ Custom OpenWrt Build Information

          - **OpenWrt Version**: \`${{ env.openwrt_version }}\`
          - **Target**: \`${{ env.target }}\`
          - **Profile**: \`${{ env.profile }}\`
          - **Package Selections**: ${packages_display}
          - **Disabled Services**: ${disabled_services_display}
          - **Version Code**: \`${version_code}\`
          - **UCI Defaults Scripts**: \`${scripts}\`

          ### ðŸ”— Rebuild Configuration
          
          Click to rebuild with the same settings:
          
          [\`ðŸ”„ Rebuild with this config\`](${SHARE_URL})

          -----

          | ðŸ” SHA256 Checksum |
          |:-------------------|
          ${checksums_table}
          EOF

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.event.inputs.model }}-${{ env.openwrt_version }}-${{ env.commit_hash }}
          tag_name: ${{ env.revision_number }}-${{ github.event.inputs.model }}
          body_path: build_info.md
          files: ${{ env.image_path }}/*
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
