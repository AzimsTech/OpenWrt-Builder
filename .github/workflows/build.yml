name: Build and Publish OpenWrt Image

on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  #push:
    #branches: [ "main" ]
  
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
permissions:
  contents: write  # Grant write permissions for release creation

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load secrets
        run: |
          find .
          cat config
          cat config >> $GITHUB_ENV
          sed -i -e 's/^# ssid=".*"/ssid="${{ secrets.WLAN_NAME }}"/' \
            -e 's/^# ssid_key=".*"/ssid_key="${{ secrets.WLAN_PASS }}"/' \
            -e 's/^# root_password=".*"/root_password="${{ secrets.ROOT_PASS }}"/' \
            -e 's/^# pppoe_name=".*"/pppoe_name="${{ secrets.PPPOE_NAME }}"/' \
            -e 's/^# pppoe_key=".*"/pppoe_key="${{ secrets.PPPOE_PASS }}"/' files/etc/uci-defaults/99-custom

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential libncurses-dev zlib1g-dev gawk wget git gettext libssl-dev xsltproc rsync unzip python3 python3-distutils zstd

      - name: Download and extract OpenWrt Image Builder
        run: |
          if [ "${{ env.openwrt_version }}" == "SNAPSHOT" ]; then
            wget https://downloads.openwrt.org/$(echo ${{ env.openwrt_version }} | tr '[:upper:]' '[:lower:]')s/targets/$(echo ${{ env.image }} | tr '-' '/')/openwrt-imagebuilder-${{ env.image }}.Linux-x86_64.tar.zst
          else
            wget https://downloads.openwrt.org/releases/${{ env.openwrt_version }}/targets/$(echo ${{ env.image }} | tr '-' '/')/openwrt-imagebuilder-${{ env.openwrt_version }}-${{ env.image }}.Linux-x86_64.tar.zst
          fi 
          tar -xvf openwrt-imagebuilder-*.tar.zst

      - name: Build OpenWrt Image
        run: |

          mv files openwrt-imagebuilder-*/
          cd openwrt-imagebuilder-*/
          pwd

          make image  \
          PROFILE="${{ env.profile }}" \
          PACKAGES="${{ env.packages }}" \
          FILES="files" \
          DISABLED_SERVICES="${{ env.disabled_services }}"
                                   
      - name: Write Build Info
        run: |

          target_dir=$(find openwrt-imagebuilder-*/bin/targets/*/*/ -type d -print -quit)
          echo "image_path=$target_dir" >> $GITHUB_ENV

          cat <<EOF > build_info.md
          ## üí° Custom OpenWrt Build Information
          
          - **OpenWrt Version**: ${{ env.openwrt_version }}
          - **Image**: ${{ env.image }}
          - **Profile**: ${{ env.profile }}
          - **Packages**: ${{ env.packages }}
          - **Disabled Services**: ${{ env.disabled_services }}
          -----
          ### üîê sha256sum

          $(awk '{if ($2 ~ /sysupgrade\.bin$/) printf "`%s` ***sysupgrade.bin**\n", $1; 
          else if ($2 ~ /factory\.bin$/) printf "`%s` ***factory.bin**\n", $1}' $target_dir/sha256sums)
          EOF
          
          cd openwrt-imagebuilder-*/
          mv bin ..

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}-${{ env.profile }}-${{ env.openwrt_version }}
          body_path: build_info.md
          files: |
            openwrt-imagebuilder-*/bin/targets/*/*/
